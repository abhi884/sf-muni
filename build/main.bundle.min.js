!function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=6)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.WIDTH=1600,t.HEIGHT=650,t.MAP_CENTER_LAT=37.7749,t.MAP_CENTER_LON=-122.4294,t.MAP_SATURATION=-75,t.MAP_LIGHTNESS=10,t.MAP_ZOOM=12,t.MAP_COLOR=["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],t.CIRCLE_RADIUS=3,t.SELECTED_CIRCLE_RADIUS=8,t.REFRESH_LOCATION=15e3,t.LAYERS=[{id:1,value:"arteries",text:"Arteries",type:"line"},{id:2,value:"freeways",text:"Freeways",type:"line"},{id:3,value:"neighborhoods",text:"Neighborhoods",type:"path"},{id:4,value:"streets",text:"Streets",type:"line"}],t.API_ROUTE_LIST="http://webservices.nextbus.com/service/publicJSONFeed?command=routeList&a=sf-muni",t.API_LOCATION="http://webservices.nextbus.com/service/publicJSONFeed?command=vehicleLocations&a=sf-muni",t.API_ROUTE_PATH="http://webservices.nextbus.com/service/publicJSONFeed?command=routeConfig&a=sf-muni&r="},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.select2=t.map=void 0;var o=n(0),r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(o);t.map=function(){return new google.maps.Map(d3.select("#map").node(),{zoom:r.MAP_ZOOM,center:new google.maps.LatLng(r.MAP_CENTER_LAT,r.MAP_CENTER_LON),mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{stylers:[{saturation:r.MAP_SATURATION},{lightness:r.MAP_LIGHTNESS}]}]})},t.select2=function(e,t){$(e).select2(t)}},function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.LayerPath=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=n(0),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(i);t.LayerPath=function(){function e(){o(this,e),this.overlayProjection={},this.svgContainer={},this.selectedPath={}}return r(e,[{key:"getPaths",value:function(e,t,n){var o=this;t.selectAll(".layer-path").remove(),o.svgContainer=t,o.overlayProjection=e;var r=a.LAYERS;o.selectedPath={},n>0&&(o.selectedPath=r[n-1]),void 0!==o.selectedPath.value&&d3.json("assets/data/"+o.selectedPath.value+".json",function(e,t){if(e)throw e;t=[t.features],o.drawPaths(t)})}},{key:"drawPaths",value:function(e){var t=this,n=a.MAP_COLOR,o=function(e){var n=new google.maps.LatLng(e[1],e[0]),o=t.overlayProjection.fromLatLngToDivPixel(n);return[o.x,o.y]},r=d3.geo.path().projection(o),i=t.svgContainer.selectAll("g").data(e).enter().append("g").attr("class","layer-path").attr("pointer-events","all"),s=i.selectAll("path").data(function(e){return e}).enter().append("path").attr("d",r);"line"===t.selectedPath.type?s.style("fill","none").style("stroke","#4886b8").style("opacity",.9):s.style("fill",function(e,t){return n[t%n.length]}).style("stroke","#4886b8").style("opacity",.5)}}]),e}()},function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.LiveLocation=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=n(0),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(i);t.LiveLocation=function(){function e(){o(this,e),this.vehicleLocations=[],this.vehicleLocationsObj={},this.routes={},this.initialized=!1,this.svgContainer={},this.overlayProjection={},this.divTooltip={},this.selectedRoutes=[]}return r(e,[{key:"initOverlay",value:function(e,t,n,o,r,i){var s=this;t.onAdd=function(){n=d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class","live-locations"),r=n.append("svg").attr("width",$(window).width()).attr("height",$(window).height()).attr("class","overlay").attr("pointer-events","all"),i=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),s.svgContainer=r,s.divTooltip=i,t.draw=function(){o=this.getProjection(),s.overlayProjection=o,s.drawLocations(),setInterval(function(){s.getLocations()},a.REFRESH_LOCATION)}},t.setMap(e)}},{key:"getLocations",value:function(e,t,n,o,r,i){var s=this;d3.json(a.API_LOCATION,function(a,l){if(a)throw a;l=l.vehicle,s.vehicleLocations=l.map(function(e){return e.title=s.routes[e.routeTag].title,e}),s.initialized?s.drawLocations():(s.initOverlay(e,t,n,o,r,i),s.initialized=!0)})}},{key:"drawLocations",value:function(){var e=this,t=[],n=a.CIRCLE_RADIUS;if(0===e.selectedRoutes.length)e.svgContainer.selectAll(".layer-route").remove(),t=e.vehicleLocations;else{for(var o=0;o<e.selectedRoutes.length;o++)for(var r=0;r<e.vehicleLocations.length;r++)e.selectedRoutes[o]===e.vehicleLocations[r].routeTag&&t.push(e.vehicleLocations[r]);n=a.SELECTED_CIRCLE_RADIUS}e.svgContainer.selectAll(".live-markers").remove();var i=e.svgContainer.selectAll("circle").data(t).enter().append("circle").attr("class","live-markers").style("cursor","pointer");i.attr("cx",function(t){return e.transform(t).x}).attr("cy",function(t){return e.transform(t).y}).attr("r",n).style("fill","green").on("mouseover",function(t){e.divTooltip.transition().duration(200).style("opacity",.9);var n="";-1===t.dirTag.indexOf("_O")?n="Outbound":-1===t.dirTag.indexOf("_I")&&(n="Inbound"),e.divTooltip.html(t.title+"<br/>Direction : "+n).style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(t){e.divTooltip.transition().duration(500).style("opacity",0)})}},{key:"transform",value:function(e){return e=new google.maps.LatLng(e.lat,e.lon),e=this.overlayProjection.fromLatLngToDivPixel(e)}},{key:"newRoutes",set:function(e){this.routes=e}}]),e}()},function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.RoutePath=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=n(0),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(i);t.RoutePath=function(){function e(){o(this,e),this.routesData={},this.stops={},this.svgContainer={},this.overlayProjection={},this.initialized=!1}return r(e,[{key:"getRoute",value:function(e){var t=this;void 0!==t.routesData[e]?t.drawRoute(t.routesData[e].route.direction):d3.json(a.API_ROUTE_PATH+e,function(n,o){if(n)throw n;o.route.stop.map(function(e){t.stops[e.tag]=e}),t.routesData[e]=o,o=o.route.direction,t.drawRoute(o)})}},{key:"drawRoute",value:function(e){var t=this,n=e[0].stop,o=e[1].stop,r=d3.svg.line().x(function(e){return t.transform(t.stops[e.tag]).x}).y(function(e){return t.transform(t.stops[e.tag]).y}).interpolate("linear");t.svgContainer.append("path").attr("d",r(n)).attr("class",function(e){return"layer-route out-bound"}).attr("stroke","orange").attr("stroke-width",4).attr("fill","none").attr("pointer-events","all");t.svgContainer.append("path").attr("d",r(o)).attr("class",function(e){return"layer-route in-bound"}).attr("stroke","yellow").attr("stroke-width",4).attr("fill","none").attr("pointer-events","all")}},{key:"transform",value:function(e){return e=new google.maps.LatLng(e.lat,e.lon),e=this.overlayProjection.fromLatLngToDivPixel(e)}}]),e}()},function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.RouteList=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=n(0),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(i);t.RouteList=function(){function e(){o(this,e),this.routes=[],this.routesList={}}return r(e,[{key:"getRoutes",value:function(){var e=this;return new Promise(function(t){$.get(a.API_ROUTE_LIST).then(function(n){n=n.route,n.map(function(t){e.routesList[t.tag]=t,t.text=t.title,t.id=t.tag}),e.routes=n,t()}).catch(function(e){t(e)})})}}]),e}()},function(e,t,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}var r=n(0),i=o(r),a=n(1),s=o(a),l=n(5),u=n(3),c=n(4),f=n(2),v=s.map(),d=new google.maps.OverlayView,p=void 0,h=void 0,y=new l.RouteList,g=new u.LiveLocation,P=new c.RoutePath,L=new f.LayerPath;y.getRoutes().then(function(e){$("#route-select").select2({data:y.routes}),g.newRoutes=y.routesList,g.getLocations(v,d,void 0,p,h,void 0)},function(e){}),$("#route-select").select2({}).on("change",function(e){m()}),$("#layer-select").select2({data:i.LAYERS,maximumSelectionLength:1}).on("change",function(e){_()}),v.addListener("zoom_changed",function(){_(),g.initialized&&m()});var m=function(){if(void 0!==h||void 0!==g.svgContainer.length){void 0===h&&(h=g.svgContainer,p=g.overlayProjection);for(var e=$("#route-select option:selected"),t=[],n=0;n<e.length;n++)t.push(e[n].value);h.selectAll(".layer-route").remove(),h.selectAll(".live-markers").remove();P.svgContainer=h,P.overlayProjection=p;for(var o=0;o<t.length;o++)P.getRoute(t[o]);g.selectedRoutes=t,g.drawLocations()}},_=function(){if(void 0!==h||void 0!==g.svgContainer.length){void 0===h&&(h=g.svgContainer,p=g.overlayProjection);var e=$("#layer-select option:selected");1===e.length?L.getPaths(p,h,e[0].value):L.getPaths(p,h,"")}}}]);